<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="-1">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  <script src="https://code.jquery.com/jquery-3.2.1.min.js"
    integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>

  <script src="https://app.five9.com/consoles/SocialWidget/five9-social-widget.min.js"></script>

  <style type="text/css">
    #new-frame {
      height: 625px;
      width: 359px;
      border: none;
    }

    .five9-frame #five9-popout-button {
      display: none;
    }

    .five9-text {
      color: rgb(255, 255, 255) !important;
      font-size: 1.5rem !important;
      vertical-align: bottom !important;
    }

    .five9-text::after {
      content: " Now" !important;
      font-size: 1.5rem !important;
    }

    #five9-minimize-icon {
      vertical-align: bottom !important;
    }

    #five9-popout-button {
      background-size: 24px 24px !important;
      height: 24px !important;
      width: 24px !important;
      vertical-align: bottom !important;
    }

    #five9-minimize-button {
      box-sizing: border-box;
    }
  </style>

  <script>
    $(document).ready(function () {
      var lastChatStep = null;
      var checkInterval = null;
      var urlParams = null;
      var tenant = "Duly Health and Wellness"; // declare here or pass as query string parameters.
      var profiles = "ZZZ_TAM_Chat,General Inquiry,Schedule or Manage Primary Care Appointment,Schedule or Manage Pediatric Appointment,Prescription Refill Request"; // declare here or pass as query string parameters.
      var title = "Duly Health and Care";
      var label = "Reason for contact";
      var nameField = "";
      var questionsField = "";
      var emailField = "";
      var UserLocale = "en";

      const PrintCurrentChatState = () => {
        let now = new Date();
        let chatSessionId, chatAgentName, chatAgentId, chatQuestion, chatReason, customerName, customerEmail;
        currentState = "";
        console.log('localstorage keys --------------------------');
        for (x in localStorage) {
          if (x.indexOf('f9-chat') >= 0) {
            let jsonObj = JSON.parse(unescape(localStorage.getItem(x)));
            currentState = jsonObj.session.id + " | " + jsonObj.session.tenant + " | " + jsonObj.email + " | " + jsonObj.step + " | " + now;
            console.log("Last Chat Step = ", lastChatStep)
            if (lastChatStep == null && jsonObj.step == "Finished") {
              jsonObj.step = "Overwritten";
              localStorage.setItem(x, escape(JSON.stringify(jsonObj)));
            }
            else if (jsonObj.step == "Finished") {
              // set values to send to VIVR survey
              chatSessionId = jsonObj.session.id;
              chatAgentId = jsonObj.session.agent.agentId;
              chatAgentName = jsonObj.session.agent.name;
              chatProfile = jsonObj.information.profile;
              chatQuestion = jsonObj.information.question;
              customerName = jsonObj.information.name;
              customerEmail = jsonObj.information.email;


              console.log("End of chat detected");
              clearInterval(checkInterval);
              $('#five9-frame-full > div.five9-header + div').html('');
              url = `https://api.five9.com/ivr/1/134857/campaigns/300000000000390/new_ivr_session?customerName=${customerName}&chatSessionId=${chatSessionId}&chatAgentId=${chatAgentId}&chatAgentName=${chatAgentName}&chatQuestion=${chatQuestion}&customerEmail=${customerEmail}&chatProfile=${chatProfile}`;
              let newIframe = $('<iframe></iframe').attr('id', 'new-frame').attr('src', url);
              $('#five9-frame-full > div.five9-header + div').append(newIframe);
            }
            lastChatStep = jsonObj.step;
            console.log(currentState);
          }
        }
      }

      const LaunchChatEmail = (tenant, profiles) => {

        if (Array.of(urlParams).length > 0) {
          nameField = urlParams.get('name');
          emailField = urlParams.get('email');
          if (tenant == "") {
            tenant = decodeURI(urlParams.get('tenant'));
          }
          if (profiles == "") {
            profiles = decodeURI(urlParams.get('profiles'));
          }
        }

        var customFields = {
          name: {
            label: 'Name',
            value: nameField,
          },
          question: {
            label: 'Question'
          },
          email: {
            label: "Email",
            show: true,
            value: emailField
          },
          dob: {
            value: "",
            label: "Date of Birth",
          },
          Provider: {
            value: "",
            label: "Provider",
          },
          userLocale: {
            label: "UserLocale",
            show: false,
            value: UserLocale

          }
        };

        var options = {
          "rootUrl": "https://app.five9.com/consoles/",
          "type": "chat",
          "title": title,
          "tenant": tenant,
          "profiles": profiles,
          "showProfiles": true,
          "autostart": true,
          "profileLabel": label,
          "theme": "",
          "surveyOptions": {
            "showComment": true,
            "requireComment": false
          },
          "fields": customFields,
          "playSoundOnMessage": true,
          "allowCustomerToControlSoundPlay": false,
          "showEmailButton": true,
          "hideDuringAfterHours": true,
          "useBusinessHours": true,
          "showPrintButton": false,
          "allowUsabilityMenu": false,
          "enableCallback": false,
          "callbackList": "",
          "allowRequestLiveAgent": false
        };

        Five9SocialWidget.addWidget(options);

      } //end LaunchChatEmail


      checkInterval = setInterval(PrintCurrentChatState, 1000);
      urlParams = new URLSearchParams(location.search);

      LaunchChatEmail(tenant, profiles);
      $('#five9-maximize-button').click();

    });

  </script>